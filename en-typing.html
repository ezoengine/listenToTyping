<link rel="import" href="bower_components/polymer/polymer.html">
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<polymer-element name="en-typing" attributes='videoid time'>
  <template>
    <style>
    </style>
  <google-youtube id='player' videoid="{{videoid}}" height="0px" width="0px" rel="0" start="5"></google-youtube>  
  <content></content>
  </template>
  <script>
  Polymer({
    playTimeoutId:'',
    play:function(len){
      var start = len.split(',')[0].trim();
      var end = len.split(',')[1].trim();
      var self = this;
      var player = self.$.player;
      player.seekTo(start);
      player.play();
      var duTime = (end - start) * 1000;
      clearTimeout(self.playTimeoutId);
      self.playTimeoutId = setTimeout(function () {
        player.pause();
      }, duTime);
    },
    ready: function(){
      var self = this;
      var ctx = [],term ='';
      var rawData = $(this).html().trim();
      for(var i=0;i<rawData.length;i++){
        var c = rawData.charAt(i);
        if(c==' ' || c==',' || c=='.'){
          ctx.push(term);
          ctx.push(c);
          term = '';
        } else{
          term += c;
        }
      }
      var size = $(this).attr('fontsize');
      $(this).html('');
      $(ctx).each(function(idx,term){
        if(term.length==1 && term==','){
          $(self).append(',&nbsp;');
          return;
        }else if(term.length==1 && term==' '){
          $(self).append('&nbsp;');
          return;
        }else if(term.length==1 && term=='.'){
          $(self).append('.');
          return;
        }else if(term.length==1 && term=='?'){
          $(self).append('?');
          return;
        }
        if(term.length>0){
        var input = $("<input type='text' maxlength='"+term.length+"' >");
        input.css({
          'font-size':size+'px',
          'width':term.length*size*2/3+'px',
          'text-align':'center'
        });
        input.data('ans',term);
        input.on('keyup',function(e){
          //Mac [cmd]
          if(e.keyCode==91){
            self.play(self.time);
            return;
          }
          var ele = e.originalEvent.srcElement;
          var value = ele.value;
          var maxval = parseInt($(ele).attr('maxlength'));
          var len = value.length;
          if(len==0 && e.keyCode==8){
            $(ele).prev('input').focus();
          }
          if(len>=maxval && e.keyCode!=9 && e.keyCode!=16){
            $(ele).next('input').focus();
            var ans = $(ele).data('ans');
            if(ans==value){
              var newEle = $('<span>'+value+'</span>').css('font-size',size+"px");
              $(ele).replaceWith(newEle);
            }
          }
        });
        $(self).append(input).append(' ');
        }
      });
    }
  });
  </script>
</polymer-element>